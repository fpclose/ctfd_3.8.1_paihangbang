{% extends "base.html" %}

{% block content %}
  <div class="jumbotron">
    <div class="container">
      <h1>
        {% trans %}Scoreboard{% endtrans %}
      </h1>
    </div>
  </div>
  <div class="container">
    {% include "components/errors.html" %}

    <div id="score-graph" class="align-items-center" :class="{'d-flex': show, 'd-none': !show}" x-data="ScoreboardDetail" x-ref="scoregraph" @bracket-change.window="activeBracket=$event.detail; update();">
      <div class="col-md-12 text-center">
        <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
      </div>
    </div>

    <div id="scoreboard" class="row" x-data="ScoreboardList">
      <!-- 赛道切换按钮 -->
      <div class="col-md-12 mb-3">
        <nav class="nav nav-pills nav-fill">
          <button class="nav-link active" data-track="all" onclick="window.switchTrack('all', this)">
            <i class="fas fa-trophy"></i> {% trans %}总榜{% endtrans %}
          </button>
          <button class="nav-link" data-track="新生赛道" onclick="window.switchTrack('新生赛道', this)">
            <i class="fas fa-graduation-cap"></i> {% trans %}新生榜{% endtrans %}
          </button>
          <button class="nav-link" data-track="进阶赛道" onclick="window.switchTrack('进阶赛道', this)">
            <i class="fas fa-rocket"></i> {% trans %}进阶榜{% endtrans %}
          </button>
          <button class="nav-link" data-track="社会赛道" onclick="window.switchTrack('社会赛道', this)">
            <i class="fas fa-users"></i> {% trans %}社会榜{% endtrans %}
          </button>
        </nav>
      </div>

      <template x-if="brackets.length && standings.length">
        <div class="col-md-12 py-3">
          <nav class="nav nav-pills nav-fill">
            <button :class="{'nav-link': true, 'active': !activeBracket}" @click="activeBracket=null">{% trans %}All{% endtrans %}</button>
            <template x-for="bracket in brackets">
              <button :class="{'nav-link': true, 'active': activeBracket == bracket.id}" x-text="bracket.name" @click="activeBracket=bracket.id"></button>
            </template>
          </nav>
        </div>
      </template>

      <div class="col-md-12" x-show="standings.length">
        <table class="table table-striped align-middle">
          <thead>
          <tr>
            <th style="width: 10px">{% trans %}Place{% endtrans %}</th>
            <th class="text-start ps-3">{{ get_mode_as_word(capitalize=True) }}</th>
            <th class="text-center">{% trans %}School{% endtrans %}</th>
            <th class="text-center">{% trans %}Score{% endtrans %}</th>
          </tr>
          </thead>

          <tbody>
            <template x-for="(standing, index) in standings.filter(i => activeBracket ? i.bracket_id==activeBracket : true)">
              <tr>
                <th scope="row" class="text-center" x-text="index + 1"></th>
                <td class="text-start">
                  <a :href="standing.account_url" x-text="standing.name"></a>
                  <template x-if="standing.bracket_name">
                    <span class="badge bg-secondary ms-2" x-text="standing.bracket_name"></span>
                  </template>
                </td>
                <td class="text-center">
                  <span x-text="standing.school || '未填写'" class="text-muted"></span>
                </td>
                <td class="text-center" x-text="standing.score"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="col-md-12" x-show="! standings.length">
        <h3 class="text-center text-muted">{% trans %}Scoreboard is empty{% endtrans %}</h3>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ Assets.js("assets/js/scoreboard.js") }}
  <script>
  // 赛道筛选功能 - 修复监听器循环触发问题
  (function() {
    let currentTrack = 'all';
    let allStandings = [];
    let scoreboardComponent = null;
    let isInitialized = false;
    let isFiltering = false;  // 添加标志位，防止循环触发
    
    // 深拷贝函数
    function deepCopy(obj) {
      return JSON.parse(JSON.stringify(obj));
    }
    
    // 等待 Alpine 组件初始化
    function waitForComponent() {
      const el = document.querySelector('#scoreboard');
      if (el && el._x_dataStack && el._x_dataStack[0]) {
        scoreboardComponent = el._x_dataStack[0];
        console.log('[赛道筛选] 组件已初始化');
        setupWatcher();
      } else {
        setTimeout(waitForComponent, 100);
      }
    }
    
    // 设置数据监听器
    function setupWatcher() {
      if (!scoreboardComponent || isInitialized) return;
      
      // 使用 Alpine 的 $watch 监听 standings 变化
      scoreboardComponent.$watch('standings', async (newValue) => {
        console.log('[赛道筛选] 检测到 standings 变化，长度:', newValue ? newValue.length : 0);
        console.log('[赛道筛选] isFiltering 标志:', isFiltering);
        
        // 如果是筛选操作导致的变化，忽略
        if (isFiltering) {
          console.log('[赛道筛选] 这是筛选操作导致的变化，忽略保存');
          return;
        }
        
        // 只保存更完整的数据（数量更多的）
        if (newValue && newValue.length > 0) {
          if (allStandings.length === 0 || newValue.length >= allStandings.length) {
            allStandings = deepCopy(newValue);
            console.log('[赛道筛选] 已保存原始数据，共', allStandings.length, '个团队');
            console.log('[赛道筛选] 原始数据:', allStandings.map(s => ({
              id: s.account_id, 
              name: s.name
            })));
            
            // 应用当前筛选
            await applyTrackFilter(currentTrack);
          } else {
            console.log('[赛道筛选] 新数据(' + newValue.length + '个)少于原始数据(' + allStandings.length + '个)，不保存');
          }
        }
      });
      
      // 检查是否已经有数据
      if (scoreboardComponent.standings && scoreboardComponent.standings.length > 0) {
        console.log('[赛道筛选] 组件已有数据，长度:', scoreboardComponent.standings.length);
        allStandings = deepCopy(scoreboardComponent.standings);
        console.log('[赛道筛选] 已保存原始数据');
        applyTrackFilter(currentTrack);
      }
      
      isInitialized = true;
      console.log('[赛道筛选] 监听器已设置');
    }
    
    // 应用赛道筛选
    async function applyTrackFilter(track) {
      if (!scoreboardComponent) {
        console.log('[赛道筛选] 组件未初始化');
        return;
      }
      
      if (allStandings.length === 0) {
        console.log('[赛道筛选] 原始数据未加载，等待中...');
        return;
      }
      
      console.log('[赛道筛选] 应用筛选，赛道:', track);
      console.log('[赛道筛选] 原始数据数量:', allStandings.length);
      
      // 设置标志位，防止触发监听器
      isFiltering = true;
      
      try {
        if (track === 'all') {
          // 显示全部
          scoreboardComponent.standings = deepCopy(allStandings);
          console.log('[赛道筛选] 显示全部团队:', scoreboardComponent.standings.length);
        } else {
          // 根据赛道筛选
          const trackTeamIds = await getTrackTeamIds(track);
          console.log('[赛道筛选] 赛道 "' + track + '" 的团队 ID:', trackTeamIds);
          
          if (trackTeamIds.length === 0) {
            scoreboardComponent.standings = [];
            console.log('[赛道筛选] 该赛道没有团队');
          } else {
            const filtered = allStandings.filter(standing => 
              trackTeamIds.includes(standing.account_id)
            );
            console.log('[赛道筛选] 筛选结果:', filtered.map(s => ({
              id: s.account_id, 
              name: s.name
            })));
            scoreboardComponent.standings = deepCopy(filtered);
            console.log('[赛道筛选] 筛选后团队数量:', scoreboardComponent.standings.length);
          }
        }
      } finally {
        // 等待下一个事件循环后再清除标志位
        setTimeout(() => {
          isFiltering = false;
          console.log('[赛道筛选] 筛选操作完成，清除标志位');
        }, 100);
      }
    }
    
    // 获取赛道团队 ID
    async function getTrackTeamIds(trackName) {
      try {
        const response = await fetch(`/api/v1/teams/track/${encodeURIComponent(trackName)}`);
        const result = await response.json();
        
        if (result.success) {
          console.log('[赛道筛选] API 返回成功:', result.data);
          return result.data;
        } else {
          console.error('[赛道筛选] API 返回失败:', result.message);
          return [];
        }
      } catch (error) {
        console.error('[赛道筛选] API 调用失败:', error);
        return [];
      }
    }
    
    // 切换赛道（暴露给全局）
    window.switchTrack = async function(track, button) {
      console.log('[赛道筛选] 切换到赛道:', track);
      currentTrack = track;
      
      // 更新按钮状态
      document.querySelectorAll('#scoreboard .nav-link[data-track]').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      
      // 应用筛选
      await applyTrackFilter(track);
    };
    
    // 页面加载后初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForComponent);
    } else {
      waitForComponent();
    }
    
    console.log('[赛道筛选] 脚本已加载');
  })();
  </script>
{% endblock %}
